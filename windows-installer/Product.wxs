<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

  <?define ProductName = "Releem Agent" ?>
  <?define Manufacturer = "Releem" ?>
  <?define Version = "1.0.0" ?>
  <?define UpgradeCode = "E8F5C9A1-2B3D-4E6F-8A9B-0C1D2E3F4A5B" ?>

  <Product Id="*"
           Name="$(var.ProductName)"
           Language="1033"
           Version="$(var.Version)"
           Manufacturer="$(var.Manufacturer)"
           UpgradeCode="$(var.UpgradeCode)">

    <Package InstallerVersion="500"
             Compressed="yes"
             InstallScope="perMachine"
             Description="$(var.ProductName) Installer"
             Manufacturer="$(var.Manufacturer)"
             Platform="x64" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed."
                  AllowSameVersionUpgrades="yes" />

    <MediaTemplate EmbedCab="yes" />

    <!-- Properties for user input (collected via UI dialogs) -->
    <Property Id="RELEEM_APIKEY" Secure="yes" />
    <Property Id="MYSQL_HOST" Value="127.0.0.1" Secure="yes" />
    <Property Id="MYSQL_PORT" Value="3306" Secure="yes" />
    <Property Id="MYSQL_USER" Value="releem" Secure="yes" />
    <Property Id="MYSQL_PASSWORD" Secure="yes" />
    <Property Id="QUERY_OPTIMIZATION" Value="true" Secure="yes" />

    <!-- Installation directory structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLDIR" Name="Releem">
          <!-- Directory will be created by custom action -->
          <Component Id="InstallDirComponent" Guid="A1B2C3D4-E5F6-7890-ABCD-EF1234567890" Win64="yes">
            <CreateFolder />
            <RemoveFolder Id="RemoveInstallDir" On="uninstall" />
          </Component>
        </Directory>
      </Directory>
      <Directory Id="CommonAppDataFolder">
        <Directory Id="CONFIGDIR" Name="Releem">
          <Component Id="ConfigDirComponent" Guid="B2C3D4E5-F6A7-8901-BCDE-F12345678901" Win64="yes">
            <CreateFolder />
            <RemoveFolder Id="RemoveConfigDir" On="uninstall" />
          </Component>
          <Directory Id="CONFDDIR" Name="conf.d">
            <Component Id="ConfDDirComponent" Guid="C3D4E5F6-A7B8-9012-CDEF-123456789012" Win64="yes">
              <CreateFolder />
              <RemoveFolder Id="RemoveConfDDir" On="uninstall" />
            </Component>
          </Directory>
        </Directory>
      </Directory>
    </Directory>

    <!-- Registry entries for Add/Remove Programs -->
    <DirectoryRef Id="INSTALLDIR">
      <Component Id="RegistryComponent" Guid="E5F6A7B8-C9D0-1234-EF01-345678901234" Win64="yes">
        <RegistryKey Root="HKLM" Key="SOFTWARE\Releem">
          <RegistryValue Type="string" Name="InstallPath" Value="[INSTALLDIR]" KeyPath="yes" />
          <RegistryValue Type="string" Name="ConfigPath" Value="[CONFIGDIR]" />
          <RegistryValue Type="string" Name="Version" Value="$(var.Version)" />
        </RegistryKey>
      </Component>
    </DirectoryRef>

    <!-- Main feature -->
    <Feature Id="MainFeature" Title="$(var.ProductName)" Level="1" Absent="disallow">
      <ComponentRef Id="InstallDirComponent" />
      <ComponentRef Id="ConfigDirComponent" />
      <ComponentRef Id="ConfDDirComponent" />
      <ComponentRef Id="RegistryComponent" />
    </Feature>

    <!-- Custom Actions -->
    <Binary Id="CustomActionsDll" SourceFile="!(bindpath.ca)\ReleemCustomActions.CA.dll" />

    <!-- Set properties for deferred custom action (install) -->
    <CustomAction Id="SetRunInstallerProperties"
                  Property="RunInstaller"
                  Value="INSTALLDIR=[INSTALLDIR];RELEEM_APIKEY=[RELEEM_APIKEY];MYSQL_HOST=[MYSQL_HOST];MYSQL_PORT=[MYSQL_PORT];MYSQL_USER=[MYSQL_USER];MYSQL_PASSWORD=[MYSQL_PASSWORD];QUERY_OPTIMIZATION=[QUERY_OPTIMIZATION]" />

    <!-- Run install.ps1 with parameters -->
    <CustomAction Id="RunInstaller"
                  BinaryKey="CustomActionsDll"
                  DllEntry="RunInstaller"
                  Execute="deferred"
                  Return="check"
                  Impersonate="no" />

    <!-- Set properties for deferred custom action (uninstall) -->
    <CustomAction Id="SetRunUninstallerProperties"
                  Property="RunUninstaller"
                  Value="INSTALLDIR=[INSTALLDIR]" />

    <!-- Run install.ps1 -Uninstall -->
    <CustomAction Id="RunUninstaller"
                  BinaryKey="CustomActionsDll"
                  DllEntry="RunUninstaller"
                  Execute="deferred"
                  Return="ignore"
                  Impersonate="no" />

    <!-- Install/Uninstall sequence -->
    <InstallExecuteSequence>
      <!-- Install: Run install.ps1 after files are installed -->
      <Custom Action="SetRunInstallerProperties" After="InstallFiles">NOT Installed AND NOT REMOVE</Custom>
      <Custom Action="RunInstaller" After="SetRunInstallerProperties">NOT Installed AND NOT REMOVE</Custom>

      <!-- Uninstall: Run install.ps1 -Uninstall before removing files -->
      <Custom Action="SetRunUninstallerProperties" Before="RemoveFiles">REMOVE="ALL"</Custom>
      <Custom Action="RunUninstaller" After="SetRunUninstallerProperties">REMOVE="ALL"</Custom>
    </InstallExecuteSequence>

    <!-- UI Reference -->
    <UIRef Id="ReleemInstallerUI" />

  </Product>
</Wix>
