<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

  <Fragment>
    <UI Id="ReleemInstallerUI">
      <UIRef Id="WixUI_Common" />

      <!-- Custom textstyles -->
      <TextStyle Id="WixUI_Font_Normal" FaceName="Tahoma" Size="8" />
      <TextStyle Id="WixUI_Font_Bigger" FaceName="Tahoma" Size="12" />
      <TextStyle Id="WixUI_Font_Title" FaceName="Tahoma" Size="9" Bold="yes" />

      <Property Id="DefaultUIFont" Value="WixUI_Font_Normal" />
      <Property Id="WixUI_Mode" Value="Custom" />

      <!-- Dialog sequence -->
      <DialogRef Id="WelcomeDlg" />
      <DialogRef Id="ProgressDlg" />
      <DialogRef Id="ErrorDlg" />
      <DialogRef Id="FatalError" />
      <DialogRef Id="FilesInUse" />
      <DialogRef Id="UserExit" />
      <DialogRef Id="ExitDialog" />

      <!-- Publish events for dialog navigation -->
      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="DbUserSetupDlg">1</Publish>

      <Publish Dialog="DbUserSetupDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg">1</Publish>
      <Publish Dialog="DbUserSetupDlg" Control="Next" Event="NewDialog" Value="ConfigurationDlg">1</Publish>

      <Publish Dialog="ConfigurationDlg" Control="Back" Event="NewDialog" Value="DbUserSetupDlg">1</Publish>
      <Publish Dialog="ConfigurationDlg" Control="Next" Event="NewDialog" Value="InstallReadyDlg">RELEEM_APIKEY AND MYSQL_PASSWORD</Publish>

      <Publish Dialog="InstallReadyDlg" Control="Back" Event="NewDialog" Value="ConfigurationDlg">1</Publish>
      <Publish Dialog="InstallReadyDlg" Control="Install" Event="NewDialog" Value="ProgressDlg">1</Publish>

      <Publish Dialog="ExitDialog" Control="Finish" Event="EndDialog" Value="Return">1</Publish>

      <!-- Admin check -->
      <Publish Dialog="WelcomeDlg" Control="Next" Event="DoAction" Value="WixUIValidatePath" Order="2">1</Publish>

      <!-- Installation complete actions -->
      <Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="LaunchDashboard">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>

      <!-- Database User Setup Dialog -->
      <Dialog Id="DbUserSetupDlg" Width="370" Height="270" Title="[ProductName] Setup">
        <Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="WixUI_Bmp_Banner" />
        <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes" Text="{\WixUI_Font_Title}Database User Setup" />
        <Control Id="Description" Type="Text" X="25" Y="23" Width="280" Height="15" Transparent="yes" NoPrefix="yes" Text="Prepare MySQL user before installation." />
        <Control Id="BannerLine" Type="Line" X="0" Y="44" Width="370" Height="0" />

        <Control Id="InstructionText" Type="Text" X="20" Y="60" Width="330" Height="60" NoPrefix="yes">
          <Text>Create a read-only MySQL user "releem" with SELECT and PROCESS privileges.

Click the button below to view the step-by-step guide.</Text>
        </Control>

        <Control Id="OpenPermissionsGuideButton" Type="PushButton" X="20" Y="125" Width="180" Height="20" Text="Open Permissions Guide">
          <Publish Event="DoAction" Value="SetPermissionsGuideUrl">1</Publish>
          <Publish Event="DoAction" Value="OpenPermissionsGuide">2</Publish>
        </Control>

        <Control Id="NoteText" Type="Text" X="20" Y="160" Width="330" Height="40" NoPrefix="yes">
          <Text>Note: You can complete this setup now or continue with the installation and configure user permissions later.</Text>
        </Control>

        <!-- Bottom line and buttons -->
        <Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0" />
        <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="&amp;Back" />
        <Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="&amp;Next" />
        <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="Cancel">
          <Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
        </Control>
      </Dialog>

      <!-- Configuration Dialog -->
      <Dialog Id="ConfigurationDlg" Width="370" Height="270" Title="[ProductName] Setup">
        <Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="WixUI_Bmp_Banner" />
        <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes" Text="{\WixUI_Font_Title}Configuration Settings" />
        <Control Id="Description" Type="Text" X="25" Y="23" Width="280" Height="15" Transparent="yes" NoPrefix="yes" Text="Enter your Releem API key and MySQL connection details." />
        <Control Id="BannerLine" Type="Line" X="0" Y="44" Width="370" Height="0" />

        <!-- API Key -->
        <Control Id="ApiKeyLabel" Type="Text" X="20" Y="55" Width="150" Height="13" NoPrefix="yes" Text="API Key (required):" />
        <Control Id="GetApiKeyButton" Type="PushButton" X="250" Y="53" Width="100" Height="17" Text="Get API Key">
          <Publish Event="DoAction" Value="SetApiKeyUrl">1</Publish>
          <Publish Event="DoAction" Value="OpenApiKeyPage">2</Publish>
        </Control>
        <Control Id="ApiKeyEdit" Type="Edit" X="20" Y="68" Width="330" Height="18" Property="RELEEM_APIKEY" />

        <!-- MySQL Host -->
        <Control Id="MysqlHostLabel" Type="Text" X="20" Y="92" Width="100" Height="13" NoPrefix="yes" Text="MySQL Host:" />
        <Control Id="MysqlHostEdit" Type="Edit" X="20" Y="105" Width="160" Height="18" Property="MYSQL_HOST" />

        <!-- MySQL Port -->
        <Control Id="MysqlPortLabel" Type="Text" X="190" Y="92" Width="80" Height="13" NoPrefix="yes" Text="MySQL Port:" />
        <Control Id="MysqlPortEdit" Type="Edit" X="190" Y="105" Width="60" Height="18" Property="MYSQL_PORT" />

        <!-- MySQL User -->
        <Control Id="MysqlUserLabel" Type="Text" X="20" Y="129" Width="100" Height="13" NoPrefix="yes" Text="MySQL User:" />
        <Control Id="MysqlUserEdit" Type="Edit" X="20" Y="142" Width="160" Height="18" Property="MYSQL_USER" />

        <!-- MySQL Password -->
        <Control Id="MysqlPasswordLabel" Type="Text" X="190" Y="129" Width="120" Height="13" NoPrefix="yes" Text="MySQL Password (required):" />
        <Control Id="MysqlPasswordEdit" Type="Edit" X="190" Y="142" Width="160" Height="18" Property="MYSQL_PASSWORD" Password="yes" />

        <!-- Query Optimization Checkbox -->
        <Control Id="QueryOptCheckbox" Type="CheckBox" X="20" Y="170" Width="330" Height="18" Property="QUERY_OPTIMIZATION" CheckBoxValue="true" Text="Enable Query Optimization" />

        <!-- Bottom line and buttons -->
        <Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0" />
        <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="&amp;Back" />
        <Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="&amp;Next">
          <Condition Action="disable"><![CDATA[NOT RELEEM_APIKEY OR NOT MYSQL_PASSWORD]]></Condition>
          <Condition Action="enable"><![CDATA[RELEEM_APIKEY AND MYSQL_PASSWORD]]></Condition>
        </Control>
        <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="Cancel">
          <Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
        </Control>
      </Dialog>

      <!-- Install Ready Dialog -->
      <Dialog Id="InstallReadyDlg" Width="370" Height="270" Title="[ProductName] Setup">
        <Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="WixUI_Bmp_Banner" />
        <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes" Text="{\WixUI_Font_Title}Ready to Install" />
        <Control Id="Description" Type="Text" X="25" Y="23" Width="280" Height="15" Transparent="yes" NoPrefix="yes" Text="Click Install to begin the installation." />
        <Control Id="BannerLine" Type="Line" X="0" Y="44" Width="370" Height="0" />

        <Control Id="InstallText" Type="Text" X="20" Y="60" Width="330" Height="60" NoPrefix="yes">
          <Text>The installer will:
1. Download Releem Agent from the internet
2. Create configuration file with your settings
3. Install and start the Releem Agent service

Click Install to proceed.</Text>
        </Control>

        <Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0" />
        <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="&amp;Back" />
        <Control Id="Install" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="&amp;Install" />
        <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="Cancel">
          <Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
        </Control>
      </Dialog>
    </UI>

    <!-- Properties for dashboard launch -->
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Open Releem Dashboard" />
    <Property Id="WixShellExecTarget" Value="https://releem.com/dashboard" />

    <!-- Custom action to launch dashboard -->
    <CustomAction Id="LaunchDashboard" BinaryKey="WixCA" DllEntry="WixShellExec" Impersonate="yes" />

    <!-- Custom actions to open links -->
    <CustomAction Id="SetApiKeyUrl" Property="WixShellExecTarget" Value="https://app.releem.com/profile" />
    <CustomAction Id="OpenApiKeyPage" BinaryKey="WixCA" DllEntry="WixShellExec" Impersonate="yes" />

    <CustomAction Id="SetPermissionsGuideUrl" Property="WixShellExecTarget" Value="https://docs.releem.com/releem-agent/mysql-permissions" />
    <CustomAction Id="OpenPermissionsGuide" BinaryKey="WixCA" DllEntry="WixShellExec" Impersonate="yes" />
  </Fragment>
</Wix>
